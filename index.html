<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูุณูุงุฑุงุช (ูุฏูุฌ JsBarcode)</title>
    <style>
        /* ุงูุชูุณูู ุงูุฃุณุงุณู ูุงููุถุน ุงูุฏุงูู */
        body { 
            font-family: 'Courier New', Courier, monospace; 
            font-weight: bold;                          
            background-color: #000000; /* ุฎูููุฉ ุณูุฏุงุก */
            color: #f0f0f0; /* ูุต ุฃุจูุถ ูุงุชุญ */
            padding: 10px; 
        }
        form { 
            width: 100%; margin: 0 auto; 
            background: #1e1e1e; /* ุฎูููุฉ ุงููููุฐุฌ ุฏุงููุฉ */
            padding: 30px; border-radius: 8px; 
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); 
        }
        fieldset { border: 1px solid #333; padding: 20px; margin-bottom: 30px; border-radius: 5px; }
        legend { font-size: 1.5em; font-weight: bold; color: #007bff; padding: 0 10px; }
        .form-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; }
        .form-group > div { flex: 1 1 150px; min-width: 150px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #cccccc; white-space: nowrap; }
        
        /* ุชูุณูู ูุฑุจุนุงุช ุงูุฅุฏุฎุงู ูู ุฌููุน ุงูุฃูุณุงู */
        input[type="text"], 
        input[type="number"], 
        input[type="date"], 
        textarea, 
        select { 
            width: 100%; 
            padding: 12px; 
            background-color: #2a2a2a; 
            color: #ffffff; 
            border: 1px solid #555; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 16px; 
            text-align: center;
            -webkit-appearance: none; 
        }
        
        /* ุงูุชูุณูู ุงูุฎุงุต ุจูุณู ุงูุฅุฏุฎุงู ุงูุฃุณุงุณู */
        fieldset:first-of-type input, fieldset:first-of-type select {
            background-color: #ffffe0 !important; 
            color: #0056b3 !important; 
            font-weight: bold !important; 
        }
        
        .full-width { flex: 1 1 100%; }
        
        /* ุชูุณูู ุงูุฃุฒุฑุงุฑ */
        .action-buttons { 
            display: flex; 
            justify-content: flex-start; 
            gap: 10px; 
            margin-top: 20px; 
            flex-wrap: wrap; 
        }
        .action-buttons button, .report-buttons button, .import-export-area button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.3s;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1em;
            flex-grow: 1; /* ููุณูุงุญ ููุฃุฒุฑุงุฑ ุจุงูุชูุณุน ูู ุงูุฌูุงู */
        }
        #save-data { background-color: #28a745; color: white; }
        #update-data { background-color: #ffc107; color: #333; }
        #delete-data { background-color: #dc3545; color: white; }
        #add-oil-record { background-color: #17a2b8; color: white; }
        #save-oil-edit { background-color: #007bff; color: white; display: none; }
        #add-maintenance-record { background-color: #8c5dff; color: white; }
        #save-maintenance-edit { background-color: #007bff; color: white; display: none; }
        #add-parts-record { background-color: #6f42c1; color: white; }
        #save-parts-edit { background-color: #007bff; color: white; display: none; }
        
        /* ุชูุณูู ุฎุงุต ุจููุทูุฉ ุงูุงุณุชูุฑุงุฏ ูุงูุชุตุฏูุฑ ุงูุฌุฏูุฏุฉ */
        .import-export-area {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .import-export-area input[type="file"] {
            flex-grow: 2;
        }

        /* ุชูุณูู ุงูุฌุฏุงูู ูุนูุงุตุฑ ุงูุทุจุงุนุฉ */
        .records-container { 
            padding: 20px; 
            background-color: #2a2a2a; 
            border-radius: 8px; 
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.05); 
            overflow-x: auto; 
            margin-top: 20px;
        }
        .car-records-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            font-size: 0.9em; 
            min-width: 1200px; 
            font-family: 'Courier New', Courier, monospace;
        }
        .car-records-table th, .car-records-table td { border: 1px solid #555; padding: 8px; text-align: right; }
        .car-records-table th { 
            background-color: #444444; 
            font-weight: bold; 
            color: #ffffff; 
        }
        .car-records-table th:last-child, .car-records-table td:last-child {
            text-align: left;
        }
        
        /* ุงุณุชุนูุงู ุฎุงุต ุจุงูุดุงุดุงุช ุงูุตุบูุฑุฉ (ุงูุฌูุงู) */
        @media (max-width: 600px) {
            .action-buttons button, .report-buttons button, .import-export-area button {
                width: 100%; 
                padding: 15px; 
                font-size: 1.1em;
            }
            .action-buttons, .report-buttons, .import-export-area {
                flex-direction: column; 
            }
            .form-group > div { 
                flex: 1 1 100%; 
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

    <form onsubmit="event.preventDefault()">
        <h1>ูุธุงู ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูุณูุงุฑุงุช</h1>

        ---

        <fieldset>
            <legend>๐ ุฃููุงู: ุจูุงูุงุช ุงูุณูุงุฑุฉ ุงูุฃุณุงุณูุฉ</legend>
            <div class="form-group full-width">
                <div style="flex: 1 1 300px;">
                    <label for="car-selector">ุงุฎุชุฑ ููุน ุงูุณูุงุฑุฉ:</label>
                    <select id="car-selector" onchange="loadCarData(this.value)">
                        <option value="">** ุงุฎุชุฑ ุฃู ุฃุฏุฎู ุจูุงูุงุช ุฌุฏูุฏุฉ **</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <div><label for="car-make">ุงูุตูุน:</label><input type="text" id="car-make" data-key="make" required></div>
                <div><label for="car-model">ุงูุทุฑุงุฒ:</label><input type="text" id="car-model" data-key="model" required></div>
                <div><label for="car-year">ุงูููุฏูู:</label><input type="number" id="car-year" data-key="year" min="1900" max="2100" required></div>
                <div><label for="car-color">ุงูููู:</label><input type="text" id="car-color" data-key="color"></div>
                <div><label for="car-serial">ุงูุฑูู ุงูุชุณูุณูู (VIN):</label><input type="text" id="car-serial" data-key="serial" required></div>
            </div>

            <div class="form-group">
                <div><label for="recommended-oil-type">ููุน ุงูุฒูุช:</label><input type="text" id="recommended-oil-type" data-key="recommendedOilType"></div>
                <div><label for="oil-quantity">ูููุฉ ุงูุฒูุช (ุนูุจุฉ):</label><input type="text" id="oil-quantity" data-key="oilQuantity"></div>
                <div><label for="reg-expiry-date">ุงูุชูุงุก ุงูุงุณุชูุงุฑุฉ:</label><input type="date" id="reg-expiry-date" data-key="regExpiry"></div>
                <div><label for="insurance-company"> ุดุฑูุฉ ุงูุชุฃููู:</label><input type="text" id="insurance-company" data-key="insuranceCompany"></div>
                <div><label for="insurance-start-date"> ุจุฏุก ุงูุชุฃููู:</label><input type="date" id="insurance-start-date" data-key="insuranceStart"></div>
                <div><label for="insurance-end-date"> ุงูุชูุงุก ุงูุชุฃููู:</label><input type="date" id="insurance-end-date" data-key="insuranceEnd"></div>
            </div>

            <div class="action-buttons">
                <button type="button" id="save-data" onclick="saveCarData()">+ ุญูุธ ุงูุจูุงูุงุช</button>
                <button type="button" id="update-data" onclick="updateCarData()" disabled>ุชุนุฏูู ุงูุจูุงูุงุช </button>
                <button type="button" id="delete-data" onclick="deleteCarData()" disabled>ุญุฐู ุงูุจูุงูุงุช</button>
                <button type="button" onclick="clearForm()">ูุณุญ ุงููููุฐุฌ</button>
            </div>
        </fieldset>

        ---

        <fieldset id="oil-fieldset" style="display: none;">
            <legend>๐ข๏ธ ุซุงููุงู : ุณุฌู ุชุบููุฑ ุงูุฒูุช</legend>
            <div id="oil-input-fields" style="border: 1px dashed #555; padding: 15px; margin-bottom: 20px;">
                <h4>ุฃุฏุฎู ุนูููุฉ ุบูุงุฑ ุฒูุช ุฌุฏูุฏุฉ</h4>
                <div class="form-group">
                    <div><label for="oil-date">ุชุงุฑูุฎ ุงูุนูููุฉ:</label><input type="date" id="oil-date" data-oil-key="date" required></div>
                    <div><label for="oil-type">ุงุณู ุงูุฒูุช:</label><input type="text" id="oil-type" data-oil-key="oilType"></div>
                    <div><label for="air-filter">ููุชุฑ ุงูููุงุก:</label><select id="air-filter" data-oil-key="airFilter"><option value="ูู ูุชู">ูู ูุชู ุงูุชุบููุฑ</option><option value="ุชู ุงูุชุบููุฑ">ุชู ุงูุชุบููุฑ</option><option value="ุชู ุงูุชูุธูู">ุชู ุงูุชูุธูู</option></select></div>
                    <div><label for="engine-filter">ููุชุฑ ููููุฉ (ุฒูุช):</label><select id="engine-filter" data-oil-key="engineFilter"><option value="ูู ูุชู">ูู ูุชู ุงูุชุบููุฑ</option><option value="ุชู ุงูุชุบููุฑ">ุชู ุงูุชุบููุฑ</option></select></div>
                </div>
                <div class="form-group">
                    <div><label for="brake-fluid">ุฒูุช ุงููุฑุงูู:</label><select id="brake-fluid" data-oil-key="brakeFluid"><option value="ูู ูุชู">ูู ูุชู ุงูุชุบููุฑ</option><option value="ุชู ุงููุญุต">ุชู ุงููุญุต</option><option value="ุชู ุงูุชุบููุฑ">ุชู ุงูุชุบููุฑ</option></select></div>
                    <div><label for="water">ููุงู ููุณูุงุฑุฉ:</label><select id="water" data-oil-key="water"><option value="ูู ูุชู">ูู ูุชู ุงูุชุบููุฑ</option><option value="ุชู ุงููุญุต">ุชู ุงููุญุต</option><option value="ุชู ุงูุฅุถุงูุฉ">ุชู ุงูุฅุถุงูุฉ</option></select></div>
                    <div><label for="steering-fluid">ุฒูุช ุงูุฏุฑูุณููู:</label><select id="steering-fluid" data-oil-key="steeringFluid"><option value="ูู ูุชู">ูู ูุชู ุงูุชุบููุฑ</option><option value="ุชู ุงููุญุต">ุชู ุงููุญุต</option><option value="ุชู ุงูุชุบููุฑ">ุชู ุงูุชุบููุฑ</option></select></div>
                    <div><label for="gear-oil">ุฒูุช ุงูููุฑ:</label><select id="gear-oil" data-oil-key="gearOil"><option value="ูู ูุชู">ูู ูุชู ุงูุชุบููุฑ</option><option value="ุชู ุงููุญุต">ุชู ุงููุญุต</option><option value="ุชู ุงูุชุบููุฑ">ุชู ุงูุชุบููุฑ</option></select></div>
                </div>
                <div class="form-group">
                    <div><label for="current-reading">ูุฑุงุกุฉ ุงูุนุฏุงุฏ ุงูุญุงููุฉ (ูู):</label><input type="number" id="current-reading" data-oil-key="currentReading" min="0" required></div>
                    <div><label for="oil-validity">ุตูุงุญูุฉ ุงูุฒูุช (ูู):</label><input type="number" id="oil-validity" data-oil-key="oilValidity" min="1000"></div>
                    <div><label for="next-change-at">ุงูุบูุงุฑ ุงููุงุฏู ุณูููู ุนูู ูุฑุงุกุฉ:</label><input type="number" id="next-change-at" data-oil-key="nextChangeAt" min="0" readonly></div>
                </div>
                <div class="form-group full-width">
                    <div class="full-width"><label for="oil-notes">ููุงุญุธุงุช:</label><textarea id="oil-notes" data-oil-key="notes"></textarea></div>
                </div>
                <div class="action-buttons">
                    <button type="button" id="add-oil-record" onclick="addOilRecord()" disabled>+ ุญูุธ ุงูุจูุงูุงุช  </button>
                    <button type="button" id="save-oil-edit" onclick="saveOilEdit()">๐พ ุญูุธ ุงูุจูุงูุงุช</button>
                    <button type="button" onclick="clearOilForm()">ูุณุญ ุงูุจูุงูุงุช</button>
                </div>
            </div>

            <h4 style="margin-top: 10px;">ุณุฌูุงุช ุงูุฒููุช ููุฐู ุงูุณูุงุฑุฉ</h4>
            <div id="oil-records-output" class="records-container">
                </div>
        </fieldset>
        
        ---

        <fieldset id="maintenance-fieldset" style="display: none;">
            <legend>๐ง ุซุงูุซุงู : ุณุฌู ุงูุตูุงูุฉ ูุงูุฅุตูุงุญุงุช</legend>

            <div id="maintenance-input-fields" style="border: 1px dashed #555; padding: 15px; margin-bottom: 20px;">
                <h4>ุฅุฏุฎู ูุฑุช ุตูุงูุฉ ุฌุฏูุฏ</h4>
                
                <div class="form-group">
                    <div>
                        <label for="maintenance-date">ุชุงุฑูุฎ ุงูุนูููุฉ:</label>
                        <input type="date" id="maintenance-date" data-maint-key="date" required>
                    </div>
                    <div>
                        <label for="maintenance-type">ููุน ุงูุตูุงูุฉ:</label>
                        <select id="maintenance-type" data-maint-key="type" required>
                            <option value="">-- ุงุฎุชุฑ ููุน ุงูุตูุงูุฉ --</option>
                            <option value="ุชุบููุฑ ุฒูุช ุงููุญุฑู ูุงูููุชุฑ">ุชุบููุฑ ุฒูุช ุงููุญุฑู ูุงูููุชุฑ</option>
                            <option value="ุงุณุชุจุฏุงู ููุชุฑ ุงูููุงุก (ุงููุญุฑู)">ุงุณุชุจุฏุงู ููุชุฑ ุงูููุงุก (ุงููุญุฑู)</option>
                            <option value="ุงุณุชุจุฏุงู ููุชุฑ ููุงุก ุงูููุตูุฑุฉ (ุงููููู)">ุงุณุชุจุฏุงู ููุชุฑ ููุงุก ุงูููุตูุฑุฉ (ุงููููู)</option>
                            <option value="ุงุณุชุจุฏุงู ููุชุฑ ุงููููุฏ">ุงุณุชุจุฏุงู ููุชุฑ ุงููููุฏ</option>
                            <option value="ุงุณุชุจุฏุงู ุดูุนุงุช ุงูุฅุดุนุงู (ุงูุจูุงุฌู)">ุงุณุชุจุฏุงู ุดูุนุงุช ุงูุฅุดุนุงู (ุงูุจูุงุฌู)</option>
                            <option value="ูุญุต ูุชูุธูู ุฃุทุฑุงู ุงูุจุทุงุฑูุฉ ูุงุฎุชุจุงุฑ ููุชูุง">ูุญุต ูุชูุธูู ุฃุทุฑุงู ุงูุจุทุงุฑูุฉ ูุงุฎุชุจุงุฑ ููุชูุง</option>
                            <option value="ุงุณุชุจุฏุงู ุงูุจุทุงุฑูุฉ">ุงุณุชุจุฏุงู ุงูุจุทุงุฑูุฉ</option>
                            <option value="ูุญุต ูุชุนุจุฆุฉ ุณุงุฆู ุงูุชุจุฑูุฏ (ุฑุฏูุชุฑ)">ูุญุต ูุชุนุจุฆุฉ ุณุงุฆู ุงูุชุจุฑูุฏ (ุฑุฏูุชุฑ)</option>
                            <option value="ูุญุต ูุชุนุจุฆุฉ ุณุงุฆู ุงููุฑุงูู">ูุญุต ูุชุนุจุฆุฉ ุณุงุฆู ุงููุฑุงูู</option>
                            <option value="ูุญุต ูุชุนุจุฆุฉ ุณุงุฆู ูุงูู ุงูุญุฑูุฉ (ุงูุฌูุฑ)">ูุญุต ูุชุนุจุฆุฉ ุณุงุฆู ูุงูู ุงูุญุฑูุฉ (ุงูุฌูุฑ)</option>
                            <option value="ูุญุต ูุชุนุจุฆุฉ ุณุงุฆู ุงููุณุงุญุงุช">ูุญุต ูุชุนุจุฆุฉ ุณุงุฆู ุงููุณุงุญุงุช</option>
                            <option value="ูุญุต ูุณุชูู ุฒูุช ุงูุฏูุฑูุณ">ูุญุต ูุณุชูู ุฒูุช ุงูุฏูุฑูุณ</option>
                            <option value="ูุญุต ุถุบุท ุงูุฅุทุงุฑุงุช ูุชุนุฏููู">ูุญุต ุถุบุท ุงูุฅุทุงุฑุงุช ูุชุนุฏููู</option>
                            <option value="ูุญุต ุญุณุงุณุงุช ุงูุฅุทุงุฑุงุช ูุชุบููุฑูุง">ูุญุต ุญุณุงุณุงุช ุงูุฅุทุงุฑุงุช ูุชุบููุฑูุง</option>
                            <option value="ูุญุต ุนูู ุฏุนุณุฉ ุงูุฅุทุงุฑุงุช ูุญุงูุฉ ุงูุชุขูู">ูุญุต ุนูู ุฏุนุณุฉ ุงูุฅุทุงุฑุงุช ูุญุงูุฉ ุงูุชุขูู</option>
                            <option value="ููุงูุจุฉ ุงูุฅุทุงุฑุงุช ูุชุบููุฑ ููุงูุนูุง">ููุงูุจุฉ ุงูุฅุทุงุฑุงุช ูุชุบููุฑ ููุงูุนูุง</option>
                            <option value="ูุญุต ุงูุฅุทุงุฑ ุงูุงุญุชูุงุทู ูุงููุนุฏุงุช">ูุญุต ุงูุฅุทุงุฑ ุงูุงุญุชูุงุทู ูุงููุนุฏุงุช</option>
                            <option value="ุงุณุชุจุฏุงู ูุญูุงุช ุงููุฑุงูู ูุฎุฑุท ุงูููุจุงุช">ุงุณุชุจุฏุงู ูุญูุงุช ุงููุฑุงูู ูุฎุฑุท ุงูููุจุงุช</option>
                            <option value="ูุญุต ุงูุณููุฑ ูุงุณุชุจุฏุงููุง">ูุญุต ุงูุณููุฑ ูุงุณุชุจุฏุงููุง</option>
                            <option value="ูุญุต ุงูุฃุถูุงุก ุงูุฎุงุฑุฌูุฉ ูุงูุฏุงุฎููุฉ">ูุญุต ุงูุฃุถูุงุก ุงูุฎุงุฑุฌูุฉ ูุงูุฏุงุฎููุฉ</option>
                            <option value="ุงุณุชุจุฏุงู ูุณุงุญุงุช ุงูุฒุฌุงุฌ ุงูุฃูุงูู ูุงูุฎููู">ุงุณุชุจุฏุงู ูุณุงุญุงุช ุงูุฒุฌุงุฌ ุงูุฃูุงูู ูุงูุฎููู</option>
                            <option value="ุณููุฑุฉ ูุจููุฉ">ุณููุฑุฉ ูุจููุฉ</option>
                            <option value="ุดูุท ุงูุจูุฏู">ุดูุท ุงูุจูุฏู</option>
                            <option value="ูุญุต ูุชุดุบูู ุงูุจูู (Horn)">ูุญุต ูุชุดุบูู ุงูุจูู (Horn)</option>
                            <option value="ูุญุต ุนูู ุฃุญุฒูุฉ ุงูุฃูุงู">ูุญุต ุนูู ุฃุญุฒูุฉ ุงูุฃูุงู</option>
                            <option value="ูุญุต ููุจููุชุฑ ุงูุณูุงุฑุฉ (ูุญุต ุงูุฃุนุทุงู)">ูุญุต ููุจููุชุฑ ุงูุณูุงุฑุฉ (ูุญุต ุงูุฃุนุทุงู)</option>
                            <option value="ุฎุฏูุงุช ุงูุชูููู ูุงูุชุจุฑูุฏ">ุฎุฏูุงุช ุงูุชุชูููู ูุงูุชุจุฑูุฏ</option>
                            <option value="ุชูุธูู ูุธุงู ุญุงููุงุช ุงููููุฏ (ุงูุจุฎุงุฎุงุช)">ุชูุธูู ูุธุงู ุญุงููุงุช ุงููููุฏ (ุงูุจุฎุงุฎุงุช)</option>
                            <option value="ุงูุฃุฐุฑุนุฉ ูุงูููุตุงุช">ุงูุฃุฐุฑุนุฉ ูุงูููุตุงุช</option>
                            <option value="ุฃุนุทุงู ุงูููููุฉ">ุฃุนุทุงู ุงูููููุฉ</option>
                            <option value="ุชูุธูู ูุชูููุน ุงููุตุงุจูุญ ุงูุฃูุงููุฉ">ุชูุธูู ูุชูููุน ุงููุตุงุจูุญ ุงูุฃูุงููุฉ</option>
                            <option value="ูุญุต ุดุงูู ููุง ูุจู ุงูุณูุฑ">ูุญุต ุดุงูู ููุง ูุจู ุงูุณูุฑ (Pre-trip inspection)</option>
                            <option value="ุบุณูู ูุชูุธูู ุงูุณูุงุฑุฉ">ุบุณูู ูุชูุธูู ุงูุณูุงุฑุฉ</option>
                            <option value="ุฒุฌุงุฌ ุงูุฒุฌุงุฌ">ุฒุฌุงุฌ ุงูุฒุฌุงุฌ</option>
                            <option value="ุชูุฌูุฏ ุงูููุงุนุฏ">ุชูุฌูุฏ ุงูููุงุนุฏ</option>
                            <option value="ุงููููุงูููุง">ุงููููุงูููุง</option>
                            <option value="ุงูููุฑุจุงุก">ุงูููุฑุจุงุก</option>
                            <option value="ุงูููุจุฑ ุฌูุงุณ">ุงูููุจุฑ ุฌูุงุณ</option>
                            <option value="ูุทุน ุบูุงุฑ">ูุทุน ุบูุงุฑ</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <div class="full-width">
                        <label for="maintenance-details">ุจูุงู ุจุงูุตูุงูุฉ (ูุง ุชู ุนููู):</label>
                        <textarea id="maintenance-details" data-maint-key="details" required></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <div>
                        <label for="parts-cost">ุชูููุฉ ูุทุน ุงูุบูุงุฑ (SAR):</label>
                        <input type="number" id="parts-cost" data-maint-key="partsCost" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    <div>
                        <label for="labor-cost">ุชูููุฉ ุงูุตูุงูุฉ (ุฃุฌุฑุฉ ุงููุฏ ุงูุนุงููุฉ) (SAR):</label>
                        <input type="number" id="labor-cost" data-maint-key="laborCost" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    <div>
                        <label for="total-cost">ูุฌููุน ุงูุชูููุฉ (SAR):</label>
                        <input type="number" id="total-cost" data-maint-key="totalCost" min="0" step="0.01" readonly>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" id="add-maintenance-record" onclick="addMaintenanceRecord()" disabled>+ ุญูุธ ุงูุจูุงูุงุช</button>
                    <button type="button" id="save-maintenance-edit" onclick="saveMaintenanceEdit()">๐พ ุญูุธ ุชุนุฏูู ุงูุณุฌู</button>
                    <button type="button" onclick="clearMaintenanceForm()">ูุณุญ ุงูุจูุงูุงุช</button>
                </div>
            </div>

            <h4 style="margin-top: 10px;">ุณุฌูุงุช ุงูุตูุงูุฉ ูุงูุฅุตูุงุญุงุช ููุฐู ุงูุณูุงุฑุฉ</h4>
            <div id="maintenance-records-output" class="records-container">
                </div>
        </fieldset>
        
        ---

        <fieldset id="parts-fieldset" style="display: none;">
            <legend>๐ฉ ุฑุงุจุนุงู : ุณุฌู ููุงุชูุฑ ูุทุน ุงูุบูุงุฑ</legend>
            <div id="parts-input-fields" style="border: 1px dashed #555; padding: 15px; margin-bottom: 20px;">
                <h4>ุฃุฏุฎู ูุงุชูุฑุฉ ูุทุน ุบูุงุฑ ุฌุฏูุฏุฉ</h4>
                
                <div class="form-group">
                    <div><label for="parts-date">ุชุงุฑูุฎ ุงูุดุฑุงุก:</label><input type="date" id="parts-date" data-parts-key="date" required></div>
                    <div><label for="parts-store-name">ุงุณู ุงููุญู:</label><input type="text" id="parts-store-name" data-parts-key="storeName" required></div>
                    <div><label for="parts-store-phone">ุฑูู ุงููุงุชู:</label><input type="number" id="parts-store-phone" data-parts-key="storePhone" min="0"></div>
                    <div>
                        <label for="parts-oem-number">ุฑูู ุงููุทุนุฉ (OEM Number):</label>
                        <input type="text" id="parts-oem-number" data-parts-key="oemNumber" oninput="generateBarcode()">
                    </div>
                    <div>
                        <label for="parts-barcode">ุจุงุฑููุฏ ุงููุทุนุฉ:</label>
                        <input type="text" id="parts-barcode" data-parts-key="barcode" placeholder="ุณูุชู ุชูููุฏู ุชููุงุฆูุงู" readonly>
                    </div>
                </div>

                <div class="form-group full-width">
                    <div class="full-width" style="text-align: center; border: 1px dashed #777; padding: 10px; margin-top: 10px;">
                        <label>ุนุฑุถ ุงูุจุงุฑููุฏ (SVG):</label>
                        <div id="barcode-display-area" style="margin-top: 10px;">
                            <p style="color: #ccc;">(ูุธูุฑ ุงูุจุงุฑููุฏ ููุง ุจุนุฏ ุฅุฏุฎุงู ุฑูู ุงููุทุนุฉ)</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <div class="full-width"><label for="parts-description">ุงููุตู ูุงูุงุณู:</label><textarea id="parts-description" data-parts-key="description" required></textarea></div>
                </div>

                <div class="form-group full-width">
                    <div class="full-width"><label for="parts-warranty">ุงูุถูุงู:</label><textarea id="parts-warranty" data-parts-key="warranty"></textarea></div>
                </div>

                <div class="form-group">
                    <div>
                        <label for="parts-cost-per-unit">ุชูููุฉ ุงููุทุนุฉ ุงููุงุญุฏุฉ (SAR):</label>
                        <input type="number" id="parts-cost-per-unit" data-parts-key="costPerUnit" min="0" step="0.01" oninput="calculatePartsTotal()">
                    </div>
                    <div>
                        <label for="parts-quantity">ุนุฏุฏ ุงููุทุน:</label>
                        <input type="number" id="parts-quantity" data-parts-key="quantity" min="1" step="1" oninput="calculatePartsTotal()" required>
                    </div>
                    <div>
                        <label for="parts-tax-rate">ุงูุถุฑูุจุฉ ุงูููุถุงูุฉ (ูช):</label>
                        <input type="number" id="parts-tax-rate" data-parts-key="taxRate" min="0" step="0.01" value="15" oninput="calculatePartsTotal()">
                    </div>
                    <div>
                        <label for="parts-total-cost">ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ (SAR):</label>
                        <input type="number" id="parts-total-cost" data-parts-key="totalCost" min="0" step="0.01" readonly>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" id="add-parts-record" onclick="addPartsRecord()" disabled>+ ุญูุธ ุงูุจูุงูุงุช</button>
                    <button type="button" id="save-parts-edit" onclick="savePartsEdit()">๐พ ุญูุธ ุชุนุฏูู ุงูุณุฌู</button>
                    <button type="button" onclick="clearPartsForm()">ูุณุญ ุงูุจูุงูุงุช</button>
                </div>
            </div>

            <h4 style="margin-top: 10px;">ุณุฌูุงุช ูุทุน ุงูุบูุงุฑ ููุฐู ุงูุณูุงุฑุฉ</h4>
            <div id="parts-records-output" class="records-container">
                </div>
        </fieldset>
        
        ---

        <fieldset id="reports-fieldset" style="display: none;">
            <legend>๐ ุฎุงูุณุงู: ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช</legend>

            <div style="border: 1px dashed #555; padding: 15px; margin-bottom: 20px;">
                <h4>๐   ุชูุฑูุฑ ุชุบููุฑ ุงูุฒูุช</h4>
                <div class="form-group">
                    <div>
                        <label for="oil-report-month">ุงุฎุชุฑ ุงูุดูุฑ:</label>
                        <select id="oil-report-month">
                            <option value="">ูู ุงูุดููุฑ</option>
                            <option value="01">ููุงูุฑ</option><option value="02">ูุจุฑุงูุฑ</option><option value="03">ูุงุฑุณ</option>
                            <option value="04">ุฃุจุฑูู</option><option value="05">ูุงูู</option><option value="06">ููููู</option>
                            <option value="07">ููููู</option><option value="08">ุฃุบุณุทุณ</option><option value="09">ุณุจุชูุจุฑ</option>
                            <option value="10">ุฃูุชูุจุฑ</option><option value="11">ููููุจุฑ</option><option value="12">ุฏูุณูุจุฑ</option>
                        </select>
                    </div>
                    <div>
                        <label for="oil-report-year">ุงุฎุชุฑ ุงูุณูุฉ:</label>
                        <select id="oil-report-year" required></select>
                    </div>
                </div>
                <div class="report-buttons">
                    <button type="button" id="print-oil-report-filtered" onclick="printFilteredReport('oil')">ุนุฑุถ ูุทุจุงุนุฉ ุงูุชูุฑูุฑ (ุดูุฑู/ุณููู)</button>
                    <button type="button" class="full-report-btn" onclick="printFullReport('oil')">ุทุจุงุนุฉ ุชูุฑูุฑ ุงูุฒููุช ุงููุงูู</button>
                </div>
            </div>

            <div style="border: 1px dashed #555; padding: 15px; margin-bottom: 20px;">
                <h4>๐   ุชูุฑูุฑ ุงูุตูุงูุฉ ูุงูุฅุตูุงุญุงุช</h4>
                <div class="form-group">
                    <div>
                        <label for="maintenance-report-month">ุงุฎุชุฑ ุงูุดูุฑ (ุงุฎุชูุงุฑู):</label>
                        <select id="maintenance-report-month">
                            <option value="">ูู ุงูุดููุฑ</option>
                            <option value="01">ููุงูุฑ</option><option value="02">ูุจุฑุงูุฑ</option><option value="03">ูุงุฑุณ</option>
                            <option value="04">ุฃุจุฑูู</option><option value="05">ูุงูู</option><option value="06">ููููู</option>
                            <option value="07">ููููู</option><option value="08">ุฃุบุณุทุณ</option><option value="09">ุณุจุชูุจุฑ</option>
                            <option value="10">ุฃูุชูุจุฑ</option><option value="11">ููููุจุฑ</option><option value="12">ุฏูุณูุจุฑ</option>
                        </select>
                    </div>
                    <div>
                        <label for="maintenance-report-year">ุงุฎุชุฑ ุงูุณูุฉ:</label>
                        <select id="maintenance-report-year" required></select>
                    </div>
                </div>
                <div class="report-buttons">
                    <button type="button" id="print-maintenance-report-filtered" onclick="printFilteredReport('maintenance')">ุนุฑุถ ูุทุจุงุนุฉ ุงูุชูุฑูุฑ (ุดูุฑู/ุณููู)</button>
                    <button type="button" class="full-report-btn" onclick="printFullReport('maintenance')">ุทุจุงุนุฉ ุชูุฑูุฑ ุงูุตูุงูุฉ ุงููุงูู</button>
                </div>
            </div>

            <div style="border: 1px dashed #555; padding: 15px;">
                <h4>๐   ุชูุฑูุฑ ุณุฌู ูุทุน ุงูุบูุงุฑ</h4>
                <div class="form-group">
                    <div>
                        <label for="parts-report-month">ุงุฎุชุฑ ุงูุดูุฑ (ุงุฎุชูุงุฑู):</label>
                        <select id="parts-report-month">
                            <option value="">ูู ุงูุดููุฑ</option>
                            <option value="01">ููุงูุฑ</option><option value="02">ูุจุฑุงูุฑ</option><option value="03">ูุงุฑุณ</option>
                            <option value="04">ุฃุจุฑูู</option><option value="05">ูุงูู</option><option value="06">ููููู</option>
                            <option value="07">ููููู</option><option value="08">ุฃุบุณุทุณ</option><option value="09">ุณุจุชูุจุฑ</option>
                            <option value="10">ุฃูุชูุจุฑ</option><option value="11">ููููุจุฑ</option><option value="12">ุฏูุณูุจุฑ</option>
                        </select>
                    </div>
                    <div>
                        <label for="parts-report-year">ุงุฎุชุฑ ุงูุณูุฉ:</label>
                        <select id="parts-report-year" required></select>
                    </div>
                </div>
                <div class="report-buttons">
                    <button type="button" id="print-parts-report-filtered" onclick="printFilteredReport('parts')">ุนุฑุถ ูุทุจุงุนุฉ ุงูุชูุฑูุฑ (ุดูุฑู/ุณููู)</button>
                    <button type="button" class="full-report-btn" onclick="printFullReport('parts')">ุทุจุงุนุฉ ุชูุฑูุฑ ูุทุน ุงูุบูุงุฑ ุงููุงูู</button>
                </div>
            </div>
            
        </fieldset>
        
        ---
        
        <fieldset id="import-export-fieldset">
            <legend>๐ ุณุงุฏุณุงู: ุงุณุชูุฑุงุฏ ูุชุตุฏูุฑ ุงูุจูุงูุงุช</legend>
            <p><strong>1. ุชุตุฏูุฑ ุงูุจูุงูุงุช:</strong></p>
            <div class="import-export-area">
                <button type="button" onclick="exportData()">โฌ๏ธ ุชุตุฏูุฑ ุฌููุน ุงูุจูุงูุงุช (JSON)</button>
            </div>

            <p style="margin-top: 20px;"><strong>2. ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช (ุงูุทุฑููุฉ ุงูููุตู ุจูุง ุนูู ุงูุขูููู):</strong></p>
            <div class="form-group full-width">
                <div class="full-width">
                    <label for="json-import-textarea">ุงูุตู ูุญุชูู ููู JSON ููุง (ุงูุณุฎู ุจุงููุงูู ูู ููู ุงูุชุตุฏูุฑ):</label>
                    <textarea id="json-import-textarea" rows="10" placeholder="ุงูุตู ุงููุต ููุง... ูุฌุจ ุฃู ูุจุฏุฃ ุจู { ูููุชูู ุจู }"></textarea>
                </div>
            </div>
            <div class="import-export-area">
                <button type="button" onclick="importDataManual()" style="background-color: #28a745;">โ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุจุงููุตู</button>
            </div>

            <p style="margin-top: 20px;"><strong>3. ุงูุงุณุชูุฑุงุฏ ุจููู (ูุฏ ูุง ูุนูู ุนูู ุงูุขูููู):</strong></p>
            <div class="import-export-area">
                <input type="file" id="import-file" accept=".json" style="flex-grow: 2;">
                <button type="button" onclick="importData()">โฌ๏ธ ุงุณุชูุฑุงุฏ ุจููู</button>
            </div>

        </fieldset>

        <button type="button" id="print-records" onclick="prepareAndPrint()" disabled>๐จ๏ธ ุทุจุงุนุฉ ุณุฌูุงุช ุงูุณูุงุฑุฉ ุงูุญุงููุฉ (A4 ุฃููู)</button>

    </form>

    ---

    <div id="print-area" class="print-area">
        <h2 class="print-only" id="print-car-header"></h2>
        
        <h4 class="print-only">๐ ุจูุงูุงุช ุงูุณูุงุฑุฉ ุงูุฃุณุงุณูุฉ</h4>
        <div id="print-car-data" class="print-only"></div>

        <div id="print-oil-report" class="print-only">
            <h4 id="oil-report-title" class="print-only">๐ข๏ธ ุชูุฑูุฑ ุชุบููุฑ ุงูุฒููุช (ุงูุดุงูู)</h4>
            <div id="print-oil-records" class="records-container print-only"></div>
        </div>

        <div id="print-maintenance-report" class="print-only">
            <h4 id="maintenance-report-title" class="print-only">๐ง ุชูุฑูุฑ ุงูุตูุงูุฉ ูุงูุฅุตูุงุญุงุช (ุงูุดุงูู)</h4>
            <div id="print-maintenance-records" class="records-container print-only"></div>
        </div>

        <div id="print-parts-report" class="print-only">
            <h4 id="parts-report-title" class="print-only">๐ฉ ุชูุฑูุฑ ุณุฌู ูุทุน ุงูุบูุงุฑ (ุงูุดุงูู)</h4>
            <div id="print-parts-records" class="records-container print-only"></div>
        </div>
    </div>

    ุญููู ุงูููููุฉ ูุญููุธุฉ @ ุชุฑูู ุงูุณุงูู 2025

    <script>
        // ููุงุชูุญ ุชุฎุฒูู ุงูุจูุงูุงุช
        const CAR_STORAGE_KEY = 'carDataRecords';
        const OIL_STORAGE_KEY = 'oilRecords';
        const MAINTENANCE_STORAGE_KEY = 'maintenanceRecords';
        const PARTS_STORAGE_KEY = 'partsRecords'; 
        
        // ูุชุบูุฑุงุช ุนุงูููุฉ ูุญูุธ ID ุงูุณุฌู ุงูุฐู ูุชู ุชุนุฏููู ุญุงููุงู
        let currentEditingOilRecordId = null; 
        let currentEditingMaintenanceRecordId = null; 
        let currentEditingPartsRecordId = null; 

        // ุญููู ุงููุณู ุงูุฃูู 
        const dataFields = [
            { key: 'serial', label: 'ุงูุฑูู ุงูุชุณูุณูู' },
            { key: 'make', label: 'ุงูุตูุน' },
            { key: 'model', label: 'ุงูุทุฑุงุฒ' },
            { key: 'year', label: 'ุงูููุฏูู' },
            { key: 'color', label: 'ุงูููู' },
            { key: 'recommendedOilType', label: 'ููุน ุงูุฒูุช ุงูููุตู ุจู' },
            { key: 'oilQuantity', label: 'ูููุฉ ุงูุฒูุช (ุนูุจุฉ)' },
            { key: 'regExpiry', label: 'ุงูุชูุงุก ุงูุงุณุชูุงุฑุฉ' },
            { key: 'insuranceCompany', label: 'ุดุฑูุฉ ุงูุชุฃููู' },
            { key: 'insuranceStart', label: 'ุชุงุฑูุฎ ุจุฏุก ุงูุชุฃููู' }, 
            { key: 'insuranceEnd', label: 'ุงูุชูุงุก ุงูุชุฃููู' }
        ];

        // ุญููู ุงููุณู ุงูุซุงูู
        const oilFields = [
            { key: 'date', label: 'ุชุงุฑูุฎ ุงูุนูููุฉ' },
            { key: 'oilType', label: 'ููุน ุงูุฒูุช' },
            { key: 'currentReading', label: 'ูุฑุงุกุฉ ุงูุนุฏุงุฏ' },
            { key: 'nextChangeAt', label: 'ุงูุบูุงุฑ ุงููุงุฏู' },
            { key: 'airFilter', label: 'ููุชุฑ ุงูููุงุก' },
            { key: 'engineFilter', label: 'ููุชุฑ ููููุฉ' },
            { key: 'brakeFluid', label: 'ุฒูุช ุงููุฑุงูู' },
            { key: 'water', label: 'ููุงู' },
            { key: 'steeringFluid', label: 'ุฒูุช ุงูุฏุฑูุณููู' },
            { key: 'gearOil', label: 'ุฒูุช ุงูููุฑ' },
            { key: 'notes', label: 'ููุงุญุธุงุช' }
        ];

        // ุญููู ุงููุณู ุงูุซุงูุซ
        const maintenanceFields = [
            { key: 'date', label: 'ุชุงุฑูุฎ ุงูุตูุงูุฉ' },
            { key: 'type', label: 'ููุน ุงูุตูุงูุฉ' },
            { key: 'details', label: 'ุงูุชูุงุตูู' },
            { key: 'partsCost', label: 'ุชูููุฉ ุงููุทุน (SAR)' },
            { key: 'laborCost', label: 'ุฃุฌุฑุฉ ุงูุนูู (SAR)' },
            { key: 'totalCost', label: 'ุงููุฌููุน (SAR)' }
        ];

        // ุญููู ุงููุณู ุงูุฑุงุจุน (ูุทุน ุงูุบูุงุฑ)
        const partsFields = [
            { key: 'date', label: 'ุชุงุฑูุฎ ุงูุดุฑุงุก' },
            { key: 'storeName', label: 'ุงุณู ุงููุญู' },
            { key: 'storePhone', label: 'ุฑูู ุงููุงุชู' },
            { key: 'oemNumber', label: 'ุฑูู ุงููุทุนุฉ (OEM)' },
            { key: 'barcode', label: 'ุจุงุฑููุฏ ุงููุทุนุฉ' },
            { key: 'description', label: 'ุงููุตู ูุงูุงุณู' },
            { key: 'warranty', label: 'ุงูุถูุงู' },
            { key: 'costPerUnit', label: 'ุชูููุฉ ุงููุญุฏุฉ' },
            { key: 'quantity', label: 'ุงูุนุฏุฏ' },
            { key: 'taxRate', label: 'ุงูุถุฑูุจุฉ (ูช)' },
            { key: 'totalCost', label: 'ุงูุฅุฌูุงูู (SAR)' }
        ];

        // ูุชุบูุฑ ุนุงููู ูุชุฎุฒูู ุณุฌูุงุช ุงูุณูุงุฑุฉ ุงูุญุงููุฉ
        let currentCarOilRecords = [];
        let currentCarMaintenanceRecords = [];
        let currentCarPartsRecords = [];


        // ----------------------------------------------------
        // ูุธุงุฆู ุนุงูุฉ ูุดุชุฑูุฉ
        // ----------------------------------------------------
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            // dateString is expected to be 'DD-MM-YYYY' from the input type="date"
            return dateString.replace(/-/g, '/');
        }

        function getCarRecords() {
            const records = localStorage.getItem(CAR_STORAGE_KEY);
            return records ? JSON.parse(records) : {};
        }

        function getOilRecords() {
            const records = localStorage.getItem(OIL_STORAGE_KEY);
            return records ? JSON.parse(records) : {};
        }

        function getMaintenanceRecords() {
            const records = localStorage.getItem(MAINTENANCE_STORAGE_KEY);
            return records ? JSON.parse(records) : {};
        }

        function getPartsRecords() {
            const records = localStorage.getItem(PARTS_STORAGE_KEY);
            return records ? JSON.parse(records) : {};
        }
        
        // ----------------------------------------------------
        // ูุธุงุฆู ุชุตุฏูุฑ ูุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช (ุงููุณู ุงูุณุงุฏุณ)
        // ----------------------------------------------------
        
        function downloadFile(content, fileName, contentType) {
            const a = document.createElement("a");
            const file = new Blob([content], {type: contentType});
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function exportData() {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุตุฏูุฑ ุฌููุน ุงูุจูุงูุงุช ุงููุญููุธุฉ ุญุงููุงู (ุงูุณูุงุฑุงุชุ ุงูุฒููุชุ ุงูุตูุงูุฉุ ูุทุน ุงูุบูุงุฑ)ุ')) {
                return;
            }
            try {
                const exportedData = {
                    [CAR_STORAGE_KEY]: getCarRecords(),
                    [OIL_STORAGE_KEY]: getOilRecords(),
                    [MAINTENANCE_STORAGE_KEY]: getMaintenanceRecords(),
                    [PARTS_STORAGE_KEY]: getPartsRecords()
                };
                
                const dataStr = JSON.stringify(exportedData, null, 2);
                const date = new Date().toISOString().slice(0, 10);
                const fileName = `Car_Data_Export_${date}.json`;
                
                downloadFile(dataStr, fileName, 'application/json');
                alert(`ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจูุฌุงุญ ูู ููู ${fileName}.`);
            } catch (error) {
                alert('ูุดู ุชุตุฏูุฑ ุงูุจูุงูุงุช: ' + error.message);
            }
        }
        
        // ๐ก ุฏุงูุฉ ุงูุงุณุชูุฑุงุฏ ุนุจุฑ ุงุฎุชูุงุฑ ููู (ูุฏ ูุง ุชุนูู ุนูู iOS)
        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู JSON ููุชุตุฏูุฑ ุฃููุงู.');
                return;
            }

            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุชุ ุณูุชู ูุณุญ ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุงุณุชุจุฏุงููุง ุจุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ุงูููู.')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const jsonContent = event.target.result;
                processImportedData(jsonContent);
            };
            
            reader.readAsText(file);
        }

        // ๐ก ุฏุงูุฉ ุงูุงุณุชูุฑุงุฏ ุนุจุฑ ุงููุตู ุงููุฏูู (ุงูููุตู ุจูุง ููุขูููู)
        function importDataManual() {
            const jsonInput = document.getElementById('json-import-textarea').value.trim();
            if (!jsonInput) {
                alert('ุงูุฑุฌุงุก ูุตู ูุญุชูู ููู JSON ูู ูุฑุจุน ุงููุต ุฃููุงู.');
                return;
            }
            
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุจุงููุตูุ ุณูุชู ูุณุญ ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุงุณุชุจุฏุงููุง ุจุงูุจูุงูุงุช ุงูููุตูุฉ.')) {
                return;
            }
            
            processImportedData(jsonInput);
        }

        // ุฏุงูุฉ ูุดุชุฑูุฉ ููุนุงูุฌุฉ ุงูุจูุงูุงุช ุงููุณุชูุฑุฏุฉ
        function processImportedData(jsonContent) {
            try {
                const importedData = JSON.parse(jsonContent);
                
                if (importedData[CAR_STORAGE_KEY] && importedData[OIL_STORAGE_KEY] && importedData[MAINTENANCE_STORAGE_KEY] && importedData[PARTS_STORAGE_KEY]) {
                    
                    localStorage.setItem(CAR_STORAGE_KEY, JSON.stringify(importedData[CAR_STORAGE_KEY]));
                    localStorage.setItem(OIL_STORAGE_KEY, JSON.stringify(importedData[OIL_STORAGE_KEY]));
                    localStorage.setItem(MAINTENANCE_STORAGE_KEY, JSON.stringify(importedData[MAINTENANCE_STORAGE_KEY]));
                    localStorage.setItem(PARTS_STORAGE_KEY, JSON.stringify(importedData[PARTS_STORAGE_KEY]));
                    
                    alert('ุชู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุจูุฌุงุญ! ุณูุชู ุชุญุฏูุซ ุงูุตูุญุฉ.');
                    window.location.reload(); 
                } else {
                    throw new Error('ุงูููู ุบูุฑ ุตุญูุญ ุฃู ูุง ูุญุชูู ุนูู ุฌููุน ููุงุชูุญ ุงูุจูุงูุงุช ุงููุทููุจุฉ.');
                }
            } catch (error) {
                alert('ูุดู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช. ุชุฃูุฏ ูู ุฃู ุงููุต ุงูููุตู ูู ููู JSON ุตุงูุญ ุชู ุชุตุฏูุฑู ูู ูุฐุง ุงููุธุงู. \nุงูุฎุทุฃ: ' + error.message);
            }
        }

        // ุฏุงูุฉ ุญุณุงุจ ุงูุฅุฌูุงูู ููุณู ุงูุตูุงูุฉ
        function calculateTotal() {
            const partsCost = parseFloat(document.getElementById('parts-cost').value) || 0;
            const laborCost = parseFloat(document.getElementById('labor-cost').value) || 0;
            const totalCostInput = document.getElementById('total-cost');
            totalCostInput.value = (partsCost + laborCost).toFixed(2);
        }

        // ุฏุงูุฉ ุญุณุงุจ ุงูุฅุฌูุงูู ููุณู ูุทุน ุงูุบูุงุฑ
        function calculatePartsTotal() {
            const costPerUnit = parseFloat(document.getElementById('parts-cost-per-unit').value) || 0;
            const quantity = parseFloat(document.getElementById('parts-quantity').value) || 0;
            const taxRate = parseFloat(document.getElementById('parts-tax-rate').value) || 0;
            
            const totalCostInput = document.getElementById('parts-total-cost');
            
            const subTotal = costPerUnit * quantity;
            const taxAmount = subTotal * (taxRate / 100);
            const total = subTotal + taxAmount;

            totalCostInput.value = total.toFixed(2);
        }

        // ุฏุงูุฉ ุชูููุฏ ุงูุจุงุฑููุฏ ุงูุญูููู ุจุงุณุชุฎุฏุงู ููุชุจุฉ JsBarcode
        function generateBarcode() {
            const oemNumberInput = document.getElementById('parts-oem-number');
            const barcodeInput = document.getElementById('parts-barcode');
            const displayArea = document.getElementById('barcode-display-area');
            const oemValue = oemNumberInput.value.trim();
            
            barcodeInput.value = oemValue; 
            displayArea.innerHTML = ''; 
            
            if (oemValue.length > 0) {
                const tempSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                tempSvg.id = "temp-barcode-svg";
                displayArea.appendChild(tempSvg);

                try {
                    JsBarcode("#temp-barcode-svg", oemValue, {
                        format: "CODE128",
                        displayValue: false, 
                        text: oemValue,
                        margin: 0, 
                        height: 40, 
                        width: 2 
                    });
                    
                    const svgHtml = tempSvg.outerHTML;
                    displayArea.innerHTML = svgHtml;

                } catch(e) {
                    displayArea.innerHTML = `<p style="color: #dc3545;">โ๏ธ ุฎุทุฃ: ูููุฉ ุงูุจุงุฑููุฏ ุบูุฑ ุตุงูุญุฉ ุฃู ูู ูุชู ุชุญููู ููุชุจุฉ JsBarcode.</p>`;
                }
            } else {
                displayArea.innerHTML = '<p style="color: #ccc;">(ูุธูุฑ ุงูุจุงุฑููุฏ ููุง ุจุนุฏ ุฅุฏุฎุงู ุฑูู ุงููุทุนุฉ)</p>';
            }
        }


        // ----------------------------------------------------
        // ูุธุงุฆู ุชููุฆุฉ ุญููู ุงูุณูุฉ (Report Year Initialization)
        // ----------------------------------------------------

        function populateYearSelectors() {
            const currentYear = new Date().getFullYear();
            const startYear = 2000;
            const selectors = [
                document.getElementById('oil-report-year'),
                document.getElementById('maintenance-report-year'),
                document.getElementById('parts-report-year')
            ];

            selectors.forEach(selector => {
                selector.innerHTML = ''; 
                for (let year = currentYear + 1; year >= startYear; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    selector.appendChild(option);
                    if (year === currentYear) {
                        selector.value = currentYear; 
                    }
                }
            });
        }

        // ----------------------------------------------------
        // ูุธุงุฆู ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูุณูุงุฑุงุช (ุงููุณู ุงูุฃูู)
        // ----------------------------------------------------

        function populateCarSelector() {
            const records = getCarRecords();
            const selector = document.getElementById('car-selector');
            const selectedValue = selector.value;
            selector.innerHTML = '<option value="">-- ุงุฎุชุฑ ุฃู ุฃุฏุฎู ุจูุงูุงุช ุฌุฏูุฏุฉ --</option>';

            Object.keys(records).forEach(vin => {
                const option = document.createElement('option');
                option.value = vin; 
                option.textContent = records[vin].make + ' ' + records[vin].model + ' (' + records[vin].year + ')';
                selector.appendChild(option);
            });
            if (records[selectedValue]) {
                selector.value = selectedValue;
            }
        }

        function clearForm() {
            document.getElementById('car-selector').value = '';
            dataFields.forEach(field => {
                const input = document.getElementById('car-' + field.key.toLowerCase());
                if (input) input.value = '';
                const dateInput = document.getElementById(field.key.replace(/([A-Z])/g, '-$1').toLowerCase() + '-date');
                if (dateInput) dateInput.value = '';
            });
            document.getElementById('recommended-oil-type').value = '';
            document.getElementById('oil-quantity').value = '';
            document.getElementById('reg-expiry-date').value = '';
            document.getElementById('insurance-company').value = '';
            document.getElementById('insurance-start-date').value = '';
            document.getElementById('insurance-end-date').value = '';

            document.getElementById('save-data').disabled = false;
            document.getElementById('update-data').disabled = true;
            document.getElementById('delete-data').disabled = true;

            // ุฅุฎูุงุก ุฃูุณุงู ุงูุณุฌูุงุช ูุงูุชูุงุฑูุฑ
            document.getElementById('oil-fieldset').style.display = 'none';
            document.getElementById('maintenance-fieldset').style.display = 'none';
            document.getElementById('parts-fieldset').style.display = 'none';
            document.getElementById('reports-fieldset').style.display = 'none';
            document.getElementById('print-records').disabled = true;
        }

        function loadCarData(vin) {
            clearForm(); 
            if (!vin) {
                return;
            }

            const records = getCarRecords();
            const car = records[vin];

            if (car) {
                dataFields.forEach(field => {
                    const input = document.getElementById('car-' + field.key.toLowerCase());
                    if (input) input.value = car[field.key] || '';
                    
                    const dateId = field.key.replace(/([A-Z])/g, '-$1').toLowerCase();
                    const dateInput = document.getElementById(dateId);
                    if (dateInput) dateInput.value = car[field.key] || '';
                });

                document.getElementById('recommended-oil-type').value = car.recommendedOilType || '';
                document.getElementById('oil-quantity').value = car.oilQuantity || '';
                document.getElementById('reg-expiry-date').value = car.regExpiry || '';
                document.getElementById('insurance-company').value = car.insuranceCompany || '';
                document.getElementById('insurance-start-date').value = car.insuranceStart || '';
                document.getElementById('insurance-end-date').value = car.insuranceEnd || '';

                document.getElementById('save-data').disabled = true;
                document.getElementById('update-data').disabled = false;
                document.getElementById('delete-data').disabled = false;
                document.getElementById('car-selector').value = vin; 

                // ุนุฑุถ ุฃูุณุงู ุงูุณุฌูุงุช
                document.getElementById('oil-fieldset').style.display = 'block';
                document.getElementById('maintenance-fieldset').style.display = 'block';
                document.getElementById('parts-fieldset').style.display = 'block';
                document.getElementById('reports-fieldset').style.display = 'block';
                document.getElementById('print-records').disabled = false;

                // ุชุญููู ุณุฌูุงุช ุงูุณูุงุฑุฉ
                loadOilRecords(vin);
                loadMaintenanceRecords(vin);
                loadPartsRecords(vin);

                // ุชูููู ุฃุฒุฑุงุฑ ุงูุฅุถุงูุฉ
                document.getElementById('add-oil-record').disabled = false;
                document.getElementById('add-maintenance-record').disabled = false;
                document.getElementById('add-parts-record').disabled = false;
            }
        }

        function saveCarData() {
            const vin = document.getElementById('car-serial').value.trim();
            if (!vin) {
                alert('ุงูุฑูู ุงูุชุณูุณูู (VIN) ูุทููุจ ูุญูุธ ุจูุงูุงุช ุงูุณูุงุฑุฉ.');
                return;
            }

            const records = getCarRecords();
            if (records[vin]) {
                alert('ูุฐู ุงูุณูุงุฑุฉ ูุณุฌูุฉ ุจุงููุนู. ุงุณุชุฎุฏู ุฒุฑ "ุชุนุฏูู ุงูุจูุงูุงุช" ูุชุญุฏูุซูุง.');
                return;
            }

            const newCar = { vin: vin };
            dataFields.forEach(field => {
                const input = document.getElementById('car-' + field.key.toLowerCase());
                if (input) newCar[field.key] = input.value.trim();
                
                const dateId = field.key.replace(/([A-Z])/g, '-$1').toLowerCase();
                const dateInput = document.getElementById(dateId);
                if (dateInput) newCar[field.key] = dateInput.value.trim();
            });

            newCar.recommendedOilType = document.getElementById('recommended-oil-type').value.trim();
            newCar.oilQuantity = document.getElementById('oil-quantity').value.trim();
            newCar.regExpiry = document.getElementById('reg-expiry-date').value.trim();
            newCar.insuranceCompany = document.getElementById('insurance-company').value.trim();
            newCar.insuranceStart = document.getElementById('insurance-start-date').value.trim();
            newCar.insuranceEnd = document.getElementById('insurance-end-date').value.trim();

            records[vin] = newCar;
            localStorage.setItem(CAR_STORAGE_KEY, JSON.stringify(records));
            alert('ุชู ุญูุธ ุจูุงูุงุช ุงูุณูุงุฑุฉ ุจูุฌุงุญ.');
            populateCarSelector();
            loadCarData(vin); 
        }

        function updateCarData() {
            const vin = document.getElementById('car-selector').value;
            if (!vin) {
                alert('ูุฌุจ ุชุญุฏูุฏ ุณูุงุฑุฉ ููุชุนุฏูู.');
                return;
            }

            const records = getCarRecords();
            const updatedCar = records[vin];

            if (!updatedCar) {
                alert('ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุณุฌู ุงูุณูุงุฑุฉ.');
                return;
            }
            
            dataFields.forEach(field => {
                const input = document.getElementById('car-' + field.key.toLowerCase());
                if (input) updatedCar[field.key] = input.value.trim();
                
                const dateId = field.key.replace(/([A-Z])/g, '-$1').toLowerCase();
                const dateInput = document.getElementById(dateId);
                if (dateInput) updatedCar[field.key] = dateInput.value.trim();
            });

            updatedCar.recommendedOilType = document.getElementById('recommended-oil-type').value.trim();
            updatedCar.oilQuantity = document.getElementById('oil-quantity').value.trim();
            updatedCar.regExpiry = document.getElementById('reg-expiry-date').value.trim();
            updatedCar.insuranceCompany = document.getElementById('insurance-company').value.trim();
            updatedCar.insuranceStart = document.getElementById('insurance-start-date').value.trim();
            updatedCar.insuranceEnd = document.getElementById('insurance-end-date').value.trim();

            records[vin] = updatedCar;
            localStorage.setItem(CAR_STORAGE_KEY, JSON.stringify(records));
            alert('ุชู ุชุนุฏูู ุจูุงูุงุช ุงูุณูุงุฑุฉ ุจูุฌุงุญ.');
            populateCarSelector();
            loadOilRecords(vin);
        }

        function deleteCarData() {
            const vin = document.getElementById('car-selector').value;
            if (!vin) {
                alert('ูุฌุจ ุชุญุฏูุฏ ุณูุงุฑุฉ ููุญุฐู.');
                return;
            }

            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุณุฌู ูุฐู ุงูุณูุงุฑุฉ ูุฌููุน ุณุฌูุงุช ุงูุตูุงูุฉ ูุงูุฒููุช ููุทุน ุงูุบูุงุฑ ุงููุฑุชุจุทุฉ ุจูุงุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.')) {
                return;
            }

            const carRecords = getCarRecords();
            delete carRecords[vin];
            localStorage.setItem(CAR_STORAGE_KEY, JSON.stringify(carRecords));

            const oilRecords = getOilRecords();
            delete oilRecords[vin];
            localStorage.setItem(OIL_STORAGE_KEY, JSON.stringify(oilRecords));
            
            const maintenanceRecords = getMaintenanceRecords();
            delete maintenanceRecords[vin];
            localStorage.setItem(MAINTENANCE_STORAGE_KEY, JSON.stringify(maintenanceRecords));

            const partsRecords = getPartsRecords();
            delete partsRecords[vin];
            localStorage.setItem(PARTS_STORAGE_KEY, JSON.stringify(partsRecords));

            alert('ุชู ุญุฐู ุณุฌู ุงูุณูุงุฑุฉ ูุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ุจูุง ุจูุฌุงุญ.');
            populateCarSelector();
            clearForm();
        }

        // ----------------------------------------------------
        // ูุธุงุฆู ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุฒููุช (ุงููุณู ุงูุซุงูู)
        // ----------------------------------------------------

        function calculateNextChange() {
            const currentReading = parseFloat(document.getElementById('current-reading').value) || 0;
            const oilValidity = parseFloat(document.getElementById('oil-validity').value) || 0;
            const nextChangeAt = document.getElementById('next-change-at');

            if (currentReading > 0 && oilValidity > 0) {
                nextChangeAt.value = currentReading + oilValidity;
            } else {
                nextChangeAt.value = '';
            }
        }

        function clearOilForm() {
            document.getElementById('oil-date').value = '';
            document.getElementById('oil-type').value = '';
            document.getElementById('current-reading').value = '';
            document.getElementById('oil-validity').value = '';
            document.getElementById('next-change-at').value = '';
            document.getElementById('oil-notes').value = '';
            document.getElementById('air-filter').value = 'ูู ูุชู';
            document.getElementById('engine-filter').value = 'ูู ูุชู';
            document.getElementById('brake-fluid').value = 'ูู ูุชู';
            document.getElementById('water').value = 'ูู ูุชู';
            document.getElementById('steering-fluid').value = 'ูู ูุชู';
            document.getElementById('gear-oil').value = 'ูู ูุชู';

            currentEditingOilRecordId = null;
            document.getElementById('add-oil-record').style.display = 'inline-block';
            document.getElementById('save-oil-edit').style.display = 'none';
        }

        function addOilRecord() {
            const vin = document.getElementById('car-selector').value;
            if (!vin) return alert('ูุฌุจ ุชุญุฏูุฏ ุณูุงุฑุฉ ุฃููุงู.');

            const oilDate = document.getElementById('oil-date').value;
            if (!oilDate) return alert('ุชุงุฑูุฎ ุงูุนูููุฉ ูุทููุจ.');

            const currentReading = parseFloat(document.getElementById('current-reading').value);
            if (!currentReading) return alert('ูุฑุงุกุฉ ุงูุนุฏุงุฏ ุงูุญุงููุฉ ูุทููุจุฉ.');

            const records = getOilRecords();
            if (!records[vin]) records[vin] = [];

            const newRecord = { id: Date.now() + Math.random() };
            oilFields.forEach(field => {
                const input = document.getElementById('oil-' + field.key.replace(/([A-Z])/g, '-$1').toLowerCase()) || document.getElementById(field.key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (input) newRecord[field.key] = input.value.trim();
            });

            newRecord.airFilter = document.getElementById('air-filter').value;
            newRecord.engineFilter = document.getElementById('engine-filter').value;
            newRecord.brakeFluid = document.getElementById('brake-fluid').value;
            newRecord.water = document.getElementById('water').value;
            newRecord.steeringFluid = document.getElementById('steering-fluid').value;
            newRecord.gearOil = document.getElementById('gear-oil').value;
            
            records[vin].push(newRecord);
            localStorage.setItem(OIL_STORAGE_KEY, JSON.stringify(records));
            alert('ุชู ุญูุธ ุณุฌู ุชุบููุฑ ุงูุฒูุช ุจูุฌุงุญ.');
            
            clearOilForm();
            loadOilRecords(vin);
        }

        function loadOilRecords(vin) {
            const records = getOilRecords()[vin] || [];
            currentCarOilRecords = records; 
            const output = document.getElementById('oil-records-output');
            output.innerHTML = '';

            if (records.length === 0) {
                output.innerHTML = '<p style="text-align: center; color: #777;">ูุง ุชูุฌุฏ ุณุฌูุงุช ุชุบููุฑ ุฒูุช ููุฐู ุงูุณูุงุฑุฉ.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'car-records-table';
            
            const thead = table.createTHead();
            let row = thead.insertRow();
            oilFields.forEach(field => {
                if (field.key !== 'notes' && field.key !== 'oilValidity' && field.key !== 'steeringFluid') { 
                    let th = document.createElement('th');
                    th.textContent = field.label;
                    row.appendChild(th);
                }
            });
            let thAction = document.createElement('th');
            thAction.textContent = 'ุงูุฅุฌุฑุงุกุงุช';
            row.appendChild(thAction);

            const tbody = table.createTBody();
            records.slice().reverse().forEach(record => { 
                let tr = tbody.insertRow();
                oilFields.forEach(field => {
                    if (field.key !== 'notes' && field.key !== 'oilValidity' && field.key !== 'steeringFluid') {
                        let td = tr.insertCell();
                        let value = record[field.key] || '-';

                        if (field.key === 'date') {
                            value = formatDate(value);
                        } else if (field.key === 'currentReading' || field.key === 'nextChangeAt') {
                            value = parseFloat(value).toLocaleString() + ' ูู';
                        }
                        
                        td.textContent = value;
                    }
                });
                
                let tdAction = tr.insertCell();
                tdAction.className = 'actions';
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'ุชุนุฏูู';
                editBtn.className = 'edit-btn';
                editBtn.onclick = () => editOilRecord(record.id, vin);
                tdAction.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'ุญุฐู';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => deleteOilRecord(record.id, vin);
                tdAction.appendChild(deleteBtn);
            });

            output.appendChild(table);
        }

        function editOilRecord(id, vin) {
            const record = currentCarOilRecords.find(r => r.id === id);
            if (!record) return;
            
            clearOilForm(); 
            currentEditingOilRecordId = id;

            oilFields.forEach(field => {
                const key = field.key;
                const input = document.getElementById('oil-' + key.replace(/([A-Z])/g, '-$1').toLowerCase()) || document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (input && record[key] !== undefined) {
                    input.value = record[key];
                }
            });

            document.getElementById('air-filter').value = record.airFilter || 'ูู ูุชู';
            document.getElementById('engine-filter').value = record.engineFilter || 'ูู ูุชู';
            document.getElementById('brake-fluid').value = record.brakeFluid || 'ูู ูุชู';
            document.getElementById('water').value = record.water || 'ูู ูุชู';
            document.getElementById('steering-fluid').value = record.steeringFluid || 'ูู ูุชู';
            document.getElementById('gear-oil').value = record.gearOil || 'ูู ูุชู';

            document.getElementById('add-oil-record').style.display = 'none';
            document.getElementById('save-oil-edit').style.display = 'inline-block';

            calculateNextChange();
        }

        function saveOilEdit() {
            const vin = document.getElementById('car-selector').value;
            if (!vin || !currentEditingOilRecordId) return;

            const oilDate = document.getElementById('oil-date').value;
            if (!oilDate) return alert('ุชุงุฑูุฎ ุงูุนูููุฉ ูุทููุจ.');

            const currentReading = parseFloat(document.getElementById('current-reading').value);
            if (!currentReading) return alert('ูุฑุงุกุฉ ุงูุนุฏุงุฏ ุงูุญุงููุฉ ูุทููุจุฉ.');

            const records = getOilRecords();
            let recordToUpdate = records[vin].find(r => r.id === currentEditingOilRecordId);

            if (recordToUpdate) {
                oilFields.forEach(field => {
                    const key = field.key;
                    const input = document.getElementById('oil-' + key.replace(/([A-Z])/g, '-$1').toLowerCase()) || document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (input) recordToUpdate[key] = input.value.trim();
                });
                
                recordToUpdate.airFilter = document.getElementById('air-filter').value;
                recordToUpdate.engineFilter = document.getElementById('engine-filter').value;
                recordToUpdate.brakeFluid = document.getElementById('brake-fluid').value;
                recordToUpdate.water = document.getElementById('water').value;
                recordToUpdate.steeringFluid = document.getElementById('steering-fluid').value;
                recordToUpdate.gearOil = document.getElementById('gear-oil').value;

                localStorage.setItem(OIL_STORAGE_KEY, JSON.stringify(records));
                alert('ุชู ุชุนุฏูู ุณุฌู ุชุบููุฑ ุงูุฒูุช ุจูุฌุงุญ.');

                clearOilForm();
                loadOilRecords(vin);
            }
        }

        function deleteOilRecord(id, vin) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุณุฌู ุชุบููุฑ ุงูุฒูุช ูุฐุงุ')) return;

            const records = getOilRecords();
            records[vin] = records[vin].filter(r => r.id !== id);
            localStorage.setItem(OIL_STORAGE_KEY, JSON.stringify(records));
            alert('ุชู ุญุฐู ุณุฌู ุชุบููุฑ ุงูุฒูุช ุจูุฌุงุญ.');
            loadOilRecords(vin);
        }

        // ----------------------------------------------------
        // ูุธุงุฆู ุฅุฏุงุฑุฉ ุณุฌูุงุช ุงูุตูุงูุฉ (ุงููุณู ุงูุซุงูุซ)
        // ----------------------------------------------------

        function clearMaintenanceForm() {
            document.getElementById('maintenance-date').value = '';
            document.getElementById('maintenance-type').value = '';
            document.getElementById('maintenance-details').value = '';
            document.getElementById('parts-cost').value = '';
            document.getElementById('labor-cost').value = '';
            document.getElementById('total-cost').value = '';
            
            currentEditingMaintenanceRecordId = null;
            document.getElementById('add-maintenance-record').style.display = 'inline-block';
            document.getElementById('save-maintenance-edit').style.display = 'none';
        }

        function addMaintenanceRecord() {
            const vin = document.getElementById('car-selector').value;
            if (!vin) return alert('ูุฌุจ ุชุญุฏูุฏ ุณูุงุฑุฉ ุฃููุงู.');

            const maintenanceDate = document.getElementById('maintenance-date').value;
            const maintenanceType = document.getElementById('maintenance-type').value;
            const maintenanceDetails = document.getElementById('maintenance-details').value;

            if (!maintenanceDate || !maintenanceType || !maintenanceDetails) {
                return alert('ุชุงุฑูุฎ ูููุน ูุชูุงุตูู ุงูุตูุงูุฉ ูุทููุจุฉ.');
            }

            const records = getMaintenanceRecords();
            if (!records[vin]) records[vin] = [];

            const newRecord = { id: Date.now() + Math.random() };
            maintenanceFields.forEach(field => {
                const input = document.getElementById(field.key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (input) newRecord[field.key] = input.value.trim();
            });

            records[vin].push(newRecord);
            localStorage.setItem(MAINTENANCE_STORAGE_KEY, JSON.stringify(records));
            alert('ุชู ุญูุธ ุณุฌู ุงูุตูุงูุฉ ุจูุฌุงุญ.');
            
            clearMaintenanceForm();
            loadMaintenanceRecords(vin);
        }

        function loadMaintenanceRecords(vin) {
            const records = getMaintenanceRecords()[vin] || [];
            currentCarMaintenanceRecords = records; 
            const output = document.getElementById('maintenance-records-output');
            output.innerHTML = '';

            if (records.length === 0) {
                output.innerHTML = '<p style="text-align: center; color: #777;">ูุง ุชูุฌุฏ ุณุฌูุงุช ุตูุงูุฉ ููุฐู ุงูุณูุงุฑุฉ.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'car-records-table';
            table.id = 'maintenance-records-table';
            
            const thead = table.createTHead();
            let row = thead.insertRow();
            maintenanceFields.forEach(field => {
                let th = document.createElement('th');
                th.textContent = field.label;
                row.appendChild(th);
            });
            let thAction = document.createElement('th');
            thAction.textContent = 'ุงูุฅุฌุฑุงุกุงุช';
            row.appendChild(thAction);

            const tbody = table.createTBody();
            records.slice().reverse().forEach(record => { 
                let tr = tbody.insertRow();
                maintenanceFields.forEach(field => {
                    let td = tr.insertCell();
                    let value = record[field.key] || '-';

                    if (field.key === 'date') {
                        value = formatDate(value);
                    } else if (field.key.includes('Cost')) {
                        value = parseFloat(value).toFixed(2) + ' SAR';
                    }
                    
                    td.textContent = value;
                });
                
                let tdAction = tr.insertCell();
                tdAction.className = 'actions';
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'ุชุนุฏูู';
                editBtn.className = 'edit-btn';
                editBtn.onclick = () => editMaintenanceRecord(record.id, vin);
                tdAction.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'ุญุฐู';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => deleteMaintenanceRecord(record.id, vin);
                tdAction.appendChild(deleteBtn);
            });

            output.appendChild(table);
        }

        function editMaintenanceRecord(id, vin) {
            const record = currentCarMaintenanceRecords.find(r => r.id === id);
            if (!record) return;
            
            clearMaintenanceForm(); 
            currentEditingMaintenanceRecordId = id;

            maintenanceFields.forEach(field => {
                const key = field.key;
                const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (input && record[key] !== undefined) {
                    input.value = record[key];
                }
            });

            document.getElementById('add-maintenance-record').style.display = 'none';
            document.getElementById('save-maintenance-edit').style.display = 'inline-block';
            
            calculateTotal();
        }

        function saveMaintenanceEdit() {
            const vin = document.getElementById('car-selector').value;
            if (!vin || !currentEditingMaintenanceRecordId) return;

            const maintenanceDate = document.getElementById('maintenance-date').value;
            const maintenanceType = document.getElementById('maintenance-type').value;
            const maintenanceDetails = document.getElementById('maintenance-details').value;

            if (!maintenanceDate || !maintenanceType || !maintenanceDetails) {
                return alert('ุชุงุฑูุฎ ูููุน ูุชูุงุตูู ุงูุตูุงูุฉ ูุทููุจุฉ.');
            }

            const records = getMaintenanceRecords();
            let recordToUpdate = records[vin].find(r => r.id === currentEditingMaintenanceRecordId);

            if (recordToUpdate) {
                maintenanceFields.forEach(field => {
                    const key = field.key;
                    const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (input) recordToUpdate[key] = input.value.trim();
                });

                records[vin] = records[vin].map(r => r.id === currentEditingMaintenanceRecordId ? recordToUpdate : r);
                localStorage.setItem(MAINTENANCE_STORAGE_KEY, JSON.stringify(records));
                alert('ุชู ุชุนุฏูู ุณุฌู ุงูุตูุงูุฉ ุจูุฌุงุญ.');

                clearMaintenanceForm();
                loadMaintenanceRecords(vin);
            }
        }

        function deleteMaintenanceRecord(id, vin) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุณุฌู ุงูุตูุงูุฉ ูุฐุงุ')) return;

            const records = getMaintenanceRecords();
            records[vin] = records[vin].filter(r => r.id !== id);
            localStorage.setItem(MAINTENANCE_STORAGE_KEY, JSON.stringify(records));
            alert('ุชู ุญุฐู ุณุฌู ุงูุตูุงูุฉ ุจูุฌุงุญ.');
            loadMaintenanceRecords(vin);
        }

        // ----------------------------------------------------
        // ูุธุงุฆู ุฅุฏุงุฑุฉ ุณุฌูุงุช ูุทุน ุงูุบูุงุฑ (ุงููุณู ุงูุฑุงุจุน)
        // ----------------------------------------------------

        function clearPartsForm() {
            document.getElementById('parts-date').value = '';
            document.getElementById('parts-store-name').value = '';
            document.getElementById('parts-store-phone').value = '';
            document.getElementById('parts-oem-number').value = '';
            document.getElementById('parts-barcode').value = '';
            document.getElementById('parts-description').value = '';
            document.getElementById('parts-warranty').value = '';
            document.getElementById('parts-cost-per-unit').value = '';
            document.getElementById('parts-quantity').value = '1'; 
            document.getElementById('parts-tax-rate').value = '15'; 
            document.getElementById('parts-total-cost').value = '';
            document.getElementById('barcode-display-area').innerHTML = '<p style="color: #ccc;">(ูุธูุฑ ุงูุจุงุฑููุฏ ููุง ุจุนุฏ ุฅุฏุฎุงู ุฑูู ุงููุทุนุฉ)</p>';
            
            currentEditingPartsRecordId = null;
            document.getElementById('add-parts-record').style.display = 'inline-block';
            document.getElementById('save-parts-edit').style.display = 'none';
        }

        function addPartsRecord() {
            const vin = document.getElementById('car-selector').value;
            if (!vin) return alert('ูุฌุจ ุชุญุฏูุฏ ุณูุงุฑุฉ ุฃููุงู.');

            const partsDate = document.getElementById('parts-date').value;
            const partsStoreName = document.getElementById('parts-store-name').value;
            const partsDescription = document.getElementById('parts-description').value;
            const partsQuantity = parseFloat(document.getElementById('parts-quantity').value);

            if (!partsDate || !partsStoreName || !partsDescription || !partsQuantity || partsQuantity <= 0) {
                return alert('ุชุงุฑูุฎ ุงูุดุฑุงุก ูุงุณู ุงููุญู ููุตู ุงููุทุนุฉ ูุงูุนุฏุฏ (ุฃูุจุฑ ูู ุตูุฑ) ูุทููุจุฉ.');
            }

            const records = getPartsRecords();
            if (!records[vin]) records[vin] = [];

            const newRecord = { id: Date.now() + Math.random() };
            partsFields.forEach(field => {
                const input = document.getElementById('parts-' + field.key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (input) newRecord[field.key] = input.value.trim();
            });

            const barcodeSvgElement = document.getElementById('barcode-display-area').querySelector('svg');
            newRecord.barcodeSvg = barcodeSvgElement ? barcodeSvgElement.outerHTML : '';


            records[vin].push(newRecord);
            localStorage.setItem(PARTS_STORAGE_KEY, JSON.stringify(records));
            alert('ุชู ุญูุธ ุณุฌู ูุทุน ุงูุบูุงุฑ ุจูุฌุงุญ.');
            
            clearPartsForm();
            loadPartsRecords(vin);
        }

        function loadPartsRecords(vin) {
            const records = getPartsRecords()[vin] || [];
            currentCarPartsRecords = records; 
            const output = document.getElementById('parts-records-output');
            output.innerHTML = '';

            if (records.length === 0) {
                output.innerHTML = '<p style="text-align: center; color: #777;">ูุง ุชูุฌุฏ ุณุฌูุงุช ูุทุน ุบูุงุฑ ููุฐู ุงูุณูุงุฑุฉ.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'car-records-table';
            table.id = 'parts-records-table';

            const thead = table.createTHead();
            let row = thead.insertRow();
            partsFields.forEach(field => {
                if (field.key !== 'barcode') { 
                    let th = document.createElement('th');
                    th.textContent = field.label;
                    row.appendChild(th);
                }
            });
            let thAction = document.createElement('th');
            thAction.textContent = 'ุงูุฅุฌุฑุงุกุงุช';
            row.appendChild(thAction);

            const tbody = table.createTBody();
            records.slice().reverse().forEach(record => { 
                let tr = tbody.insertRow();
                partsFields.forEach(field => {
                    if (field.key !== 'barcode') {
                        let td = tr.insertCell();
                        let value = record[field.key] || '-';

                        if (field.key === 'date') {
                            value = formatDate(value);
                        } else if (field.key.includes('Cost') || field.key === 'costPerUnit') {
                            value = parseFloat(value).toFixed(2) + ' SAR';
                        } else if (field.key === 'quantity') {
                            value = parseInt(value) + ' ูุทุนุฉ';
                        } else if (field.key === 'taxRate') {
                            value = parseFloat(value) + ' %';
                        }
                        
                        td.textContent = value;
                    }
                });
                
                let tdAction = tr.insertCell();
                tdAction.className = 'actions';
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'ุชุนุฏูู';
                editBtn.className = 'edit-btn';
                editBtn.onclick = () => editPartsRecord(record.id, vin);
                tdAction.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'ุญุฐู';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => deletePartsRecord(record.id, vin);
                tdAction.appendChild(deleteBtn);
            });

            output.appendChild(table);
        }

        function editPartsRecord(id, vin) {
            const record = currentCarPartsRecords.find(r => r.id === id);
            if (!record) return;
            
            clearPartsForm(); 
            currentEditingPartsRecordId = id;

            partsFields.forEach(field => {
                const key = field.key;
                const input = document.getElementById('parts-' + key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (input && record[key] !== undefined) {
                    input.value = record[key];
                }
            });

            document.getElementById('barcode-display-area').innerHTML = record.barcodeSvg || '<p style="color: #ccc;">(ูู ูุชู ุญูุธ ุงูุจุงุฑููุฏ)</p>';


            document.getElementById('add-parts-record').style.display = 'none';
            document.getElementById('save-parts-edit').style.display = 'inline-block';
            
            calculatePartsTotal();
        }

        function savePartsEdit() {
            const vin = document.getElementById('car-selector').value;
            if (!vin || !currentEditingPartsRecordId) return;

            const partsDate = document.getElementById('parts-date').value;
            const partsStoreName = document.getElementById('parts-store-name').value;
            const partsDescription = document.getElementById('parts-description').value;
            const partsQuantity = parseFloat(document.getElementById('parts-quantity').value);

            if (!partsDate || !partsStoreName || !partsDescription || !partsQuantity || partsQuantity <= 0) {
                return alert('ุชุงุฑูุฎ ุงูุดุฑุงุก ูุงุณู ุงููุญู ููุตู ุงููุทุนุฉ ูุงูุนุฏุฏ (ุฃูุจุฑ ูู ุตูุฑ) ูุทููุจุฉ.');
            }

            const records = getPartsRecords();
            let recordToUpdate = records[vin].find(r => r.id === currentEditingPartsRecordId);

            if (recordToUpdate) {
                partsFields.forEach(field => {
                    const key = field.key;
                    const input = document.getElementById('parts-' + key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (input) recordToUpdate[key] = input.value.trim();
                });
                
                const barcodeSvgElement = document.getElementById('barcode-display-area').querySelector('svg');
                recordToUpdate.barcodeSvg = barcodeSvgElement ? barcodeSvgElement.outerHTML : '';


                records[vin] = records[vin].map(r => r.id === currentEditingPartsRecordId ? recordToUpdate : r);
                localStorage.setItem(PARTS_STORAGE_KEY, JSON.stringify(records));
                alert('ุชู ุชุนุฏูู ุณุฌู ูุทุน ุงูุบูุงุฑ ุจูุฌุงุญ.');

                clearPartsForm();
                loadPartsRecords(vin);
            }
        }

        function deletePartsRecord(id, vin) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุณุฌู ูุทุน ุงูุบูุงุฑ ูุฐุงุ')) return;

            const records = getPartsRecords();
            records[vin] = records[vin].filter(r => r.id !== id);
            localStorage.setItem(PARTS_STORAGE_KEY, JSON.stringify(records));
            alert('ุชู ุญุฐู ุณุฌู ูุทุน ุงูุบูุงุฑ ุจูุฌุงุญ.');
            loadPartsRecords(vin);
        }

        // ----------------------------------------------------
        // ูุธุงุฆู ุงูุทุจุงุนุฉ ูุงูุชูุงุฑูุฑ (ุงููุณู ุงูุฎุงูุณ)
        // ----------------------------------------------------
        
        function createPrintTable(records, fields, tableId, hideFields = []) {
            if (records.length === 0) return '';
            
            let html = `<table class="car-records-table" id="${tableId}"><thead><tr>`;
            
            fields.forEach(field => {
                if (!hideFields.includes(field.key)) {
                    html += `<th>${field.label}</th>`;
                }
            });
            html += `</tr></thead><tbody>`;

            records.slice().reverse().forEach(record => {
                html += `<tr>`;
                fields.forEach(field => {
                    if (!hideFields.includes(field.key)) {
                        let value = record[field.key] || '-';
                        let tdClass = '';

                        if (field.key === 'date') {
                            value = formatDate(value);
                        } else if (field.key.includes('Cost') || field.key === 'costPerUnit') {
                            value = parseFloat(value).toFixed(2) + ' SAR';
                            tdClass = 'text-center';
                        } else if (field.key === 'quantity') {
                            value = parseInt(value) + ' ูุทุนุฉ';
                            tdClass = 'text-center';
                        } else if (field.key === 'taxRate') {
                            value = parseFloat(value) + ' %';
                            tdClass = 'text-center';
                        } else if (field.key === 'currentReading' || field.key === 'nextChangeAt') {
                            value = parseFloat(value).toLocaleString() + ' ูู';
                            tdClass = 'text-center';
                        } else if (field.key === 'barcode') {
                            value = record.barcodeSvg || '-';
                            tdClass = 'barcode-cell';
                        }

                        html += `<td class="${tdClass}" style="max-width: 150px; overflow: hidden; white-space: normal;">${value}</td>`;
                    }
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        function printFullReport(recordType) {
            const vin = document.getElementById('car-selector').value;
            if (!vin) return alert('ูุฌุจ ุชุญุฏูุฏ ุณูุงุฑุฉ ุฃููุงู ูุทุจุงุนุฉ ุงูุชูุฑูุฑ ุงูุดุงูู.');
            
            const records = getCarRecords();
            const car = records[vin];

            document.getElementById('print-car-header').textContent = `ุณุฌูุงุช ุงูุณูุงุฑุฉ: ${car.make} ${car.model} (${car.year})`;
            
            let carDataHtml = '<div style="display: flex; flex-wrap: wrap; margin-bottom: 20px;">';
            dataFields.forEach(field => {
                let value = car[field.key] || '-';
                if (field.key.includes('Expiry') || field.key.includes('Start') || field.key.includes('End')) {
                    value = formatDate(value);
                }
                carDataHtml += `<div style="flex: 1 1 30%; min-width: 200px; padding: 5px;"><strong style="color: #007bff;">${field.label}:</strong> ${value}</div>`;
            });
            carDataHtml += '</div>';
            document.getElementById('print-car-data').innerHTML = carDataHtml;


            const oilRecordsOutput = document.getElementById('print-oil-records');
            const maintenanceRecordsOutput = document.getElementById('print-maintenance-records');
            const partsRecordsOutput = document.getElementById('print-parts-records');
            
            document.getElementById('print-oil-report').style.display = 'none';
            document.getElementById('print-maintenance-report').style.display = 'none';
            document.getElementById('print-parts-report').style.display = 'none';

            let reportTitle = '';
            
            if (recordType === 'oil') {
                document.getElementById('print-oil-report').style.display = 'block';
                reportTitle = 'ุชูุงุฑูุฑ ุชุบููุฑ ุงูุฒููุช (ุงูุดุงูู)';
                const oilTableHtml = createPrintTable(currentCarOilRecords, oilFields, 'oil-records-table', ['notes', 'oilValidity', 'steeringFluid']);
                oilRecordsOutput.innerHTML = oilTableHtml;
            } else if (recordType === 'maintenance') {
                document.getElementById('print-maintenance-report').style.display = 'block';
                reportTitle = 'ุชูุงุฑูุฑ ุงูุตูุงูุฉ ูุงูุฅุตูุงุญุงุช (ุงูุดุงูู)';
                const maintenanceTableHtml = createPrintTable(currentCarMaintenanceRecords, maintenanceFields, 'maintenance-records-table');
                maintenanceRecordsOutput.innerHTML = maintenanceTableHtml;
            } else if (recordType === 'parts') {
                document.getElementById('print-parts-report').style.display = 'block';
                reportTitle = 'ุชูุงุฑูุฑ ุณุฌู ูุทุน ุงูุบูุงุฑ (ุงูุดุงูู)';
                const partsTableHtml = createPrintTable(currentCarPartsRecords, partsFields, 'parts-records-table', ['storePhone', 'taxRate', 'costPerUnit']);
                partsRecordsOutput.innerHTML = partsTableHtml;
            } else {
                return alert('ููุน ุงูุชูุฑูุฑ ุบูุฑ ุตุญูุญ.');
            }

            document.getElementById(`${recordType}-report-title`).textContent = `๐ ${reportTitle}`;

            window.print();
        }

        function printFilteredReport(recordType) {
            const vin = document.getElementById('car-selector').value;
            if (!vin) return alert('ูุฌุจ ุชุญุฏูุฏ ุณูุงุฑุฉ ุฃููุงู.');

            const yearSelector = document.getElementById(`${recordType}-report-year`);
            const monthSelector = document.getElementById(`${recordType}-report-month`);

            const year = yearSelector.value;
            const month = monthSelector.value;

            if (!year) return alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุณูุฉ ููุชูุฑูุฑ.');

            let allRecords = [];
            let fields = [];
            let tableId = `${recordType}-records-table`;
            let hideFields = [];
            let titlePrefix = `ุชูุงุฑูุฑ ${recordType === 'oil' ? 'ุชุบููุฑ ุงูุฒููุช' : recordType === 'maintenance' ? 'ุงูุตูุงูุฉ ูุงูุฅุตูุงุญุงุช' : 'ูุทุน ุงูุบูุงุฑ'}`;
            let title = `${titlePrefix} ูุนุงู ${year}`;
            
            if (recordType === 'oil') {
                allRecords = currentCarOilRecords;
                fields = oilFields;
                hideFields = ['notes', 'oilValidity', 'steeringFluid'];
            } else if (recordType === 'maintenance') {
                allRecords = currentCarMaintenanceRecords;
                fields = maintenanceFields;
            } else if (recordType === 'parts') {
                allRecords = currentCarPartsRecords;
                fields = partsFields;
                hideFields = ['storePhone', 'taxRate', 'costPerUnit'];
            }

            let filteredRecords = allRecords.filter(record => {
                if (!record.date) return false;
                const recordYear = new Date(record.date).getFullYear().toString();
                const recordMonth = (new Date(record.date).getMonth() + 1).toString().padStart(2, '0');

                if (recordYear !== year) return false;
                if (month && recordMonth !== month) return false;

                return true;
            });

            if (month) {
                title = `${titlePrefix} ูุดูุฑ ${monthSelector.options[monthSelector.selectedIndex].text} ${year}`;
            }

            if (filteredRecords.length === 0) {
                return alert(`ูุง ุชูุฌุฏ ุณุฌูุงุช ูุทุงุจูุฉ ูููุนุงููุฑ ุงููุญุฏุฏุฉ (${title}).`);
            }

            const records = getCarRecords();
            const car = records[vin];
            
            document.getElementById('print-car-header').textContent = `ุณุฌูุงุช ุงูุณูุงุฑุฉ: ${car.make} ${car.model} (${car.year})`;
            
            let carDataHtml = '<div style="display: flex; flex-wrap: wrap; margin-bottom: 20px;">';
            dataFields.forEach(field => {
                let value = car[field.key] || '-';
                if (field.key.includes('Expiry') || field.key.includes('Start') || field.key.includes('End')) {
                    value = formatDate(value);
                }
                carDataHtml += `<div style="flex: 1 1 30%; min-width: 200px; padding: 5px;"><strong style="color: #007bff;">${field.label}:</strong> ${value}</div>`;
            });
            carDataHtml += '</div>';
            document.getElementById('print-car-data').innerHTML = carDataHtml;


            const outputElement = document.getElementById(`print-${recordType}-records`);
            
            document.getElementById('print-oil-report').style.display = 'none';
            document.getElementById('print-maintenance-report').style.display = 'none';
            document.getElementById('print-parts-report').style.display = 'none';
            document.getElementById(`print-${recordType}-report`).style.display = 'block';

            document.getElementById(`${recordType}-report-title`).textContent = `๐ ${title}`;

            const tableHtml = createPrintTable(filteredRecords, fields, tableId, hideFields);
            outputElement.innerHTML = tableHtml;

            window.print();
        }

        // ----------------------------------------------------
        // ูุธุงุฆู ุงูุชููุฆุฉ (Initialization)
        // ----------------------------------------------------

        document.getElementById('current-reading').oninput = calculateNextChange;
        document.getElementById('oil-validity').oninput = calculateNextChange;
        
        document.getElementById('parts-cost').oninput = calculateTotal;
        document.getElementById('labor-cost').oninput = calculateTotal;

        document.getElementById('parts-cost-per-unit').oninput = calculatePartsTotal;
        document.getElementById('parts-quantity').oninput = calculatePartsTotal;
        document.getElementById('parts-tax-rate').oninput = calculatePartsTotal;
        
        document.addEventListener('DOMContentLoaded', () => {
            populateCarSelector();
            populateYearSelectors(); 
            // ุฅุฎูุงุก ุงูุฃูุณุงู ุนูุฏ ุงูุชุญููู
            document.getElementById('oil-fieldset').style.display = 'none';
            document.getElementById('maintenance-fieldset').style.display = 'none';
            document.getElementById('parts-fieldset').style.display = 'none'; 
            document.getElementById('reports-fieldset').style.display = 'none';
            
            // ุงูุชุฃูุฏ ูู ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูุชุนุฏูู ุนูุฏ ุงูุชุญููู
            document.getElementById('save-oil-edit').style.display = 'none';
            document.getElementById('save-maintenance-edit').style.display = 'none';
            document.getElementById('save-parts-edit').style.display = 'none'; 
        });
    </script>

</body>
</html>
